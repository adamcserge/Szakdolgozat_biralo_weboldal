<!DOCTYPE html>
<html lang="hu">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hallgatók kezelése</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="style/index.css" />
  </head>

  <body>
    <div id="app-auth">
      <div v-if="!auth">
        <p>Üdvözlöm az oldalon, kérlek jelentkezz be:</p>
        <button @click="login">Bejelentkezés</button>
      </div>

      <div v-else>
        <button @click="logout">Kijelentkezés</button>
        <p>Üdv, {{ user.rvFelhasznalonev }} ({{ user.rvEmail }})!</p>

        <h1>Hallgatók kezelése</h1>

        <!-- Hallgatók listázása -->
        <button @click="loadHallgatok">Hallgatók betöltése</button>
        <ul>
          <li v-for="hallgato in hallgatok" :key="hallgato.hallgatoID">
            {{ hallgato.hallgatoNEV }} - {{ hallgato.hallgatoNK }} - {{
            hallgato.hallgatoEMAIL }}
          </li>
        </ul>

        <!-- Hallgató hozzáadása -->
        <h2>Új hallgató hozzáadása</h2>
        <input v-model="nev" placeholder="Név" />
        <input v-model="neptun" placeholder="Neptun kód" />
        <input v-model="email" placeholder="Email" />
        <button @click="kuldes">Küldés</button>
        <p>{{ uzenet }}</p>

        <!-- Hallgató lekérdezése ID alapján -->
        <h2>Hallgató keresése ID alapján</h2>
        <input v-model="keresettID" type="number" placeholder="Hallgató ID" />
        <button @click="keresHallgato">Keresés</button>
        <div v-if="hallgato">
          <h3>Hallgató adatai:</h3>
          <p>Név: {{ hallgato.hallgatoNEV }}</p>
          <p>Neptun kód: {{ hallgato.hallgatoNK }}</p>
          <p>Email: {{ hallgato.hallgatoEMAIL }}</p>
        </div>
        <p v-if="hibaUzenet" style="color: red">{{ hibaUzenet }}</p>

        <!-- Fájl feltöltés -->
        <h2>Fájl feltöltése</h2>
        <input type="file" @change="handleFileUpload" />
        <select v-model="selectedType" placeholder="Dokumentum típusa">
          <option value="1">Szakdolgozat</option>
          <option value="2">Témakiíró lap</option>
          <option value="3">Melléklet</option>
          <option value="4">Bírálat</option>
          <option value="5">Egyéb</option>
        </select>
        <select v-model="selectedTemaID">
          <option v-for="tema in temak" :value="tema.temaID" :key="tema.temaID">
            {{ tema.temaCim }}
          </option>
        </select>
        <button @click="uploadFile">Feltöltés</button>
        <p>{{ uploadMessage }}</p>

        <!-- Feltöltött fájlok -->
        <h2>Feltöltött dokumentjai</h2>
        <button @click="loadFiles">Fájlok betöltése</button>
        <ul>
          <li v-for="file in files" :key="file.dokID">
            {{ file.eredeti_nev }}
            <button @click="downloadFile(file.eleres)">Letöltés</button>
            <button @click="torolDokumentum(file.dokID)">Törlés</button>
          </li>
        </ul>

        <!-- Téma feltöltése -->
        <h2>Új téma feltöltése</h2>
        <form @submit.prevent="submitTema">
          <input v-model="ujTema.temaCim" placeholder="Téma címe" required />

          <select v-model="ujTema.kapcsolodoTemaID">
            <option disabled value="">Kapcsolódó téma (nem kötelező)</option>
            <option
              v-for="tema in temak"
              :value="tema.temaID"
              :key="tema.temaID"
            >
              {{ tema.temaCim }}
            </option>
          </select>
          <select v-model="ujTema.hallgatoID" required>
            <option disabled value="">Válassz hallgatót</option>
            <option v-for="hallgato in hallgatok" :value="hallgato.hallgatoID">
              {{ hallgato.hallgatoNEV }} ({{ hallgato.hallgatoNK }})
            </option>
          </select>
          <div>
            <h3 @click="toggleSzervezetValasztas" style="cursor: pointer">
              Szervezet választása
              <span>{{ isSzervezetValasztasOpen ? '-' : '+' }}</span>
            </h3>
            <ul v-if="isSzervezetValasztasOpen">
              <tree-item
                v-for="szervezet in szervezetek"
                :key="szervezet.szervezetID"
                :item="szervezet"
                :selected-id="ujTema.szervezetID"
                @select="ujTema.szervezetID = $event"
              ></tree-item>
            </ul>
            <p>
              Kiválasztott szervezet: {{ getSzervezetNevById(ujTema.szervezetID)
              }}
            </p>
          </div>
          <button type="submit">Téma beküldése</button>
        </form>
        <p v-if="uzenet">{{ uzenet }}</p>
      </div>
    </div>
    <script>
      axios.defaults.withCredentials = true;
      Vue.component("tree-item", {
        props: ["item", "selectedId"],
        data() {
          return {
            isOpen: false, // A kibontás állapota
          };
        },
        computed: {
          hasChildren() {
            return this.item.children && this.item.children.length > 0;
          },
          isSelected() {
            return this.item.szervezetID === this.selectedId;
          },
        },
        methods: {
          toggle() {
            this.isOpen = !this.isOpen;
          },
          select() {
            this.$emit("select", this.item.szervezetID);
          },
        },
        template: `
    <li :class="{ selected: isSelected }">
      <div @click="toggle" style="cursor: pointer;">
        <span v-if="hasChildren">{{ isOpen ? '-' : '+' }}</span>
        <span @click.stop="select">{{ item.szervezetNEV }}</span>
      </div>
      <ul v-if="isOpen && hasChildren">
        <tree-item
          v-for="child in item.children"
          :key="child.szervezetID"
          :item="child"
          :selected-id="selectedId"
          @select="$emit('select', $event)"
        ></tree-item>
      </ul>
    </li>
  `,
      });

      new Vue({
        el: "#app-auth",
        data() {
          return {
            auth: false,
            user: null,
            hallgatok: [],
            files: [],
            nev: "",
            neptun: "",
            email: "",
            uzenet: "",
            keresettID: "",
            hallgato: null,
            hibaUzenet: "",
            selectedFile: null,
            selectedType: "1",
            selectedTemaID: null,
            temak: [], // Témák listája
            uploadMessage: "",
            ujTema: {
              temaCim: "",
              kapcsolodoTemaID: "", // Kapcsolódó téma ID
              hallgatoID: "",
              szervezetID: "",
            },
            temaUzenet: "",
            szervezetek: [], // Szervezetek hierarchikus listája
            isSzervezetValasztasOpen: false, // Szervezetválasztó nyitott állapota
          };
        },
        methods: {
          async checkLoginStatus() {
            try {
              const res = await axios.get("http://localhost:3000/api/user");
              this.user = res.data;
              this.auth = true;
            } catch (err) {
              this.auth = false;
            }
          },
          login() {
            const width = 450;
            const height = 500;
            const left = (window.screen.width - width) / 2;
            const top = (window.screen.height - height) / 2 - 100;
            window.open(
              "login.html",
              "Bejelentkezés",
              `width=${width},height=${height},left=${left},top=${top},resizable=no,scrollbars=no`
            );
          },
          async logout() {
            try {
              await axios.post("http://localhost:3000/api/logout", {});
              this.auth = false;
              this.user = null;
            } catch (err) {
              console.error("Kijelentkezési hiba:", err);
            }
          },
          async kuldes() {
            try {
              const res = await fetch("http://localhost:3000/api/hallgato", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  hallgatoNEV: this.nev,
                  hallgatoNK: this.neptun,
                  hallgatoEMAIL: this.email,
                }),
              });
              if (!res.ok) throw new Error(`Hiba: ${res.status}`);
              const data = await res.json();
              this.uzenet = data.message;
              this.nev = this.neptun = this.email = "";
              this.loadHallgatok(); // újratöltjük
            } catch (err) {
              console.error(err);
              this.uzenet = "Hiba történt a hozzáadáskor.";
            }
          },
          async loadHallgatok() {
            try {
              const res = await fetch("http://localhost:3000/api/hallgatok");
              this.hallgatok = await res.json();
            } catch (err) {
              console.error("Hallgatók betöltése hiba:", err);
            }
          },
          async keresHallgato() {
            try {
              const res = await fetch(
                `http://localhost:3000/api/hallgatok/${this.keresettID}`
              );
              if (!res.ok) throw new Error(`Hiba: ${res.status}`);
              const data = await res.json();
              if (data.length === 0) {
                this.hibaUzenet = "Nem található hallgató ezzel az ID-val.";
                this.hallgato = null;
              } else {
                this.hallgato = data[0];
                this.hibaUzenet = "";
              }
            } catch (err) {
              console.error(err);
              this.hibaUzenet = "Hiba történt a lekérdezés során.";
              this.hallgato = null;
            }
          },
          handleFileUpload(event) {
            this.selectedFile = event.target.files[0];
          },
          async fetchTemak() {
            try {
              const res = await fetch("http://localhost:3000/api/temak");
              this.temak = await res.json();
            } catch (err) {
              console.error("Témák betöltése hiba:", err);
            }
          },
          async uploadFile() {
            if (!this.selectedFile || !this.selectedTemaID) {
              this.uploadMessage = "Kérlek válassz ki fájlt és témát!";
              return;
            }
            const formData = new FormData();
            formData.append("file", this.selectedFile);
            formData.append("tipus", this.selectedType);
            formData.append("temaID", this.selectedTemaID);
            //formData.append("feltolto", this.user.rvID);
            try {
              const res = await fetch("http://localhost:3000/api/feltoltes", {
                method: "POST",
                body: formData,
                credentials: "include",
              });
              if (!res.ok) throw new Error(`Feltöltési hiba: ${res.status}`);
              const data = await res.json();
              this.uploadMessage = `Sikeresen feltöltve: ${data.fileName}`;
              this.selectedFile = null;
              this.loadFiles(); // újratöltjük a listát
            } catch (err) {
              console.error("Fájl feltöltési hiba:", err);
              this.uploadMessage = "Hiba történt a feltöltéskor.";
            }
          },
          //fájlok törlése
          async torolDokumentum(id) {
            try {
              await fetch(`http://localhost:3000/api/dokumentum/${id}`, {
                method: "DELETE",
                credentials: "include", // fontos, hogy elküldje a session cookiet
              });
              this.loadFiles(); // újratölti a listát
            } catch (err) {
              console.error("Törlési hiba:", err);
            }
          },
          confirmDelete(id) {
            if (confirm("Biztosan törölni szeretnéd a fájlt?")) {
              this.torolDokumentum(id);
            }
          },
          async loadFiles() {
            try {
              const res = await fetch(
                "http://localhost:3000/api/feltoltott-fajlok",
                { method: "GET", credentials: "include" }
              );
              this.files = await res.json();
            } catch (err) {
              console.error("Fájlok betöltése hiba:", err);
            }
          },
          async downloadFile(filename) {
            const url = `http://localhost:3000/api/letoltes/${filename}`;
            window.open(url, "_blank");
          },
          handleLoginSuccess() {
            this.checkLoginStatus();
          },
          messageListener(event) {
            if (event.data === "loginSuccess") {
              this.handleLoginSuccess();
            }
          },
          async submitTema() {
            try {
              const res = await fetch("http://localhost:3000/api/tema", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                credentials: "include",
                body: JSON.stringify(this.ujTema),
              });
              if (!res.ok) throw new Error("Téma mentése nem sikerült");
              const data = await res.json();
              this.temaUzenet = `Sikeresen mentve, ID: ${data.temaID}`;
              this.ujTema = {
                temaCim: "",
                kapcsolodoTemaID: "", // Kapcsolódó téma ID
                hallgatoID: "",
                szervezetID: "",
              };
              this.isSzervezetValasztasOpen = false; // bezárja a szervezet választót
              this.fetchTemak(); // témák frissítése
            } catch (err) {
              console.error("Téma mentési hiba:", err);
              this.temaUzenet = "Hiba történt a mentés során.";
            }
          },
          async fetchSzervezetek() {
            try {
              const response = await axios.get(
                "http://localhost:3000/api/szervezetek"
              );
              const flatData = response.data;

              // Hierarchikus struktúra létrehozása
              const map = {};
              flatData.forEach((item) => {
                map[item.szervezetID] = { ...item, children: [] };
              });

              const tree = [];
              flatData.forEach((item) => {
                if (item.felettesID) {
                  map[item.felettesID].children.push(map[item.szervezetID]);
                } else {
                  tree.push(map[item.szervezetID]);
                }
              });

              this.szervezetek = tree;
            } catch (error) {
              console.error("Hiba a szervezetek lekérésekor", error);
            }
          },
          toggleSzervezetValasztas() {
            this.isSzervezetValasztasOpen = !this.isSzervezetValasztasOpen;
          },
          getSzervezetNevById(id) {
            const findSzervezet = (szervezetek, id) => {
              for (const szervezet of szervezetek) {
                if (szervezet.szervezetID === id) {
                  return szervezet.szervezetNEV;
                }
                if (szervezet.children && szervezet.children.length > 0) {
                  const nev = findSzervezet(szervezet.children, id);
                  if (nev) return nev;
                }
              }
              return null;
            };
            return findSzervezet(this.szervezetek, id) || "Nincs kiválasztva";
          },
        },
        created() {
          this.checkLoginStatus();
          this.fetchTemak();
          this.loadHallgatok();
          this.fetchSzervezetek();
          window.addEventListener("message", this.messageListener);
        },

        beforeDestroy() {
          window.removeEventListener("message", this.messageListener);
        },
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="hu">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Szakdolgozat bíráló weboldal</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="style/index.css" />
  </head>

  <body>
    <div id="app-auth">
      <div v-if="!auth">
        <p>Üdvözlöm az oldalon, kérlek jelentkezz be:</p>
        <button @click="login">Bejelentkezés</button>
      </div>

      <div v-else>
       
        <div v-if="user.isAdmin === 1" class="admin-button">
          <button @click="OpenAdnimPage">Adminisztrációs felület</button>
        </div>
        <div v-else class="admin-button">
          <button @click="showUzenetModal = true">Ügyfélszolgálat</button>
        </div>
         <div class="logout-wrapper">
          <button @click="logout">Kijelentkezés</button>
        </div>

<!-- Üzenet küldése modal -->
        <div v-if="showUzenetModal" class="modal"> 
          <div id="uzenetKuldes">
          <select v-model="tipus">
            <option disabled value="">Válassz típust</option>
            <option>Hibás adat</option>
            <option>Új adat felvétel</option>
            <option>Hibaelhárítás</option>
            <option>Változtatás</option>
            <option>Egyéb</option>
          </select>
          <textarea v-model="tartalom" placeholder="Írd le a problémát..."></textarea>
          <button @click="kuldesUzenet">Küldés</button>
        </div>
        <button @click="showUzenetModal = false">Bezárás</button>        
          </div>  

       

        <p>Üdvözlöm az oldalon, {{ user.rvFelhasznalonev }}!</p>
         <div >
          <h3>Elküldött üzeneteid</h3>
          <ul>
            <li v-for="uzenet in uzenetek" :key="uzenet.uzenetID">
              <strong>Üzenet:</strong> {{ uzenet.tartalom }}<br />
              <strong>Állapot:</strong> {{ uzenet.allapot }}<br />
              <strong>Válasz:</strong>
              <span v-if="uzenet.valasz === null || uzenet.valasz === ''">
                Nincs még válasz.
              </span>
              <span v-else>{{ uzenet.valasz }}</span>
            </li>
          </ul>
          <p v-if="uzenetek.length === 0">Nincs elküldött üzeneted.</p>
        </div>
        <div><h2>Konzultált témái</h2>
        <input
                type="text"
                v-model="TemakSearchQuery"
                placeholder="Keresés cím alapján..."
                class="search-input"
              />

              <div class="scrollable-list">
        <template>
          <div v-if="filteredTemak.length > 0" v-for="tema in filteredTemak" :key="tema.temaID">
            <ul>
              <li class="tema-sor">
                <span class="tema-cim">{{ tema.temaCim }}</span>

                <!-- Témakiíró lap feltöltése gomb -->
                <button
                  v-if="!tema.temakiiroLapFeltoltve"
                  @click="feltoltDokumentum(tema.temaID, 1)"
                >
                  Témakiíró lap feltöltése
                </button>

                <!-- Szakdolgozat feltöltése gomb -->
                <button
                  v-if="!tema.szakdolgozatFeltoltve"
                  @click="feltoltDokumentum(tema.temaID, 2)"
                >
                  Szakdolgozat feltöltése
                </button>

                <!-- Bíráló felkérése gomb -->
                <button
                  v-if="tema.temakiiroLapFeltoltve && tema.szakdolgozatFeltoltve && tema.biralva === 0"
                  @click="openModal(tema.temaID)"
                >
                  Bíráló felkérése
                </button>
                <!-- Felkérés folyamatban szöveg -->
                <span v-else-if="tema.biralva === 1">Felkérés folyamatban</span>

                <!-- Bírálat elfogadva szöveg -->
                <span v-else-if="tema.biralva === 2">Bírálati felkérés elfogadva</span>
                <!-- Bírálat letöltése gomb -->
                <button
                  v-else-if="tema.biralva === 3"
                  @click="downloadBiralat(tema.temaID)"
                  class="biralat-letoltes-gomb"
                >
                  Bírálat letöltése
                </button>
              </li>
            </ul>
          </div>
          <div v-if="filteredTemak.length === 0"><b>Nincs találat a címek között.</b></div>
        </template>
        </div>
        </div>

          <div v-if="showModal" class="modal">
            <h3>Válassz bírálót</h3>
            <p>Téma: {{ kivalasztottTemaCim }}</p>
            <select v-model="kivalasztottBiralo">
              <option disabled value="">Válassz bírálót</option>
              <option
                v-for="biralo in biralok"
                :key="biralo.rvID"
                :value="biralo.rvID"
              >
                {{ biralo.nev }}
              </option>
            </select>
            <button @click="felkeresBiralo">Felkérés küldése</button>
            <button @click="showModal = false">Mégse</button>
          </div>
        </template>

        <!-- Fájl feltöltése -->
        <h2>Fájl feltöltése</h2>
        <input type="file" @change="handleFileUpload" />
        <select v-model="selectedType" placeholder="Dokumentum típusa">
          <option value="1">Témakiíró lap</option>
          <option value="2">Szakdolgozat</option>
          <option value="3">Titoktartási nyilatkozat</option>
          <option value="3">Melléklet</option>
          <option value="4">Bírálat</option>
          <option value="5">Egyéb</option>
        </select>
        <select v-model="selectedTemaID">
          <option
            v-for="tema in konzulensTemak"
            :value="tema.temaID"
            :key="tema.temaID"
          >
            {{ tema.temaCim }}
          </option>
        </select>
        <button @click="uploadFile">Feltöltés</button>
        <p>{{ uploadMessage }}</p>

        <!-- Feltöltött fájlok -->
        <h2>Feltöltött dokumentjai</h2>
        <button @click="loadFiles">Fájlok betöltése</button>
        <ul>
          <li v-for="file in files" :key="file.dokID">
            <strong>Téma:</strong> {{ file.temaCim || "Nincs hozzárendelve"
            }}<br />
            <strong>Típus:</strong> {{ getDokumentumTipus(file.tipus) }}<br />
            <strong>Fájl:</strong> {{ file.eredeti_nev }}
            <button @click="downloadFile(file.eleres)">Letöltés</button>
            <!-- Törlés gomb csak akkor jelenik meg, ha biralva === 0 -->
            <button
              v-if="file.biralva === 0"
              @click="confirmDelete(file.dokID)"
            >
              Törlés
            </button>
          </li>
        </ul>

        <!-- Téma feltöltése -->
        <h2>Új téma feltöltése</h2>
        <form @submit.prevent="submitTema">
         <div> 
          <input v-model="ujTema.temaCim" placeholder="Téma címe" required />
        </div>
        <div>
          <select v-model="ujTema.kapcsolodoTemaID">
            <option disabled value="">Kapcsolódó téma (nem kötelező)</option>
          </div>
          <div>
            <option
              v-for="tema in temak"
              :value="tema.temaID"
              :key="tema.temaID"
            >
              {{ tema.temaCim }}
            </option>
          </select>
        </div>
        <div>
          <select v-model="ujTema.hallgatoID" required>
            <option disabled value="">Válassz hallgatót</option>
            <option v-for="hallgato in hallgatok" :value="hallgato.hallgatoID">
              {{ hallgato.hallgatoNEV }} ({{ hallgato.hallgatoNK }})
            </option></select
          ><!-- Hallgató hozzáadása gomb -->
          <button @click="showHallgatoModal = true" title="Új hallgató felvétele"><b>+</b></button>
        </div>
        <div>
          <!-- További konzulens kiválasztása -->
          <select v-model="ujTema.extraKonzulensID">
            <option disabled value="">
              Válassz további konzulenst (nem kötelező)
            </option>
            <option
              v-for="resztvevo in resztvevok"
              :value="resztvevo.rvID"
              :key="resztvevo.rvID"
            >
              {{ resztvevo.rvNEV }} ({{ resztvevo.rvEmail }})
            </option>
          </select></div>

          <div>
            <h3 @click="toggleSzervezetValasztas" style="cursor: pointer">
              Szervezet választása
              <span>{{ isSzervezetValasztasOpen ? '-' : '+' }}</span>
            </h3>
            <ul class="szervezetfa" v-if="isSzervezetValasztasOpen">
              <tree-item
                v-for="szervezet in szervezetek"
                :key="szervezet.szervezetID"
                :item="szervezet"
                :selected-id="ujTema.szervezetID"
                @select="ujTema.szervezetID = $event"
              ></tree-item>
            </ul>
            <p>
              Kiválasztott szervezet: {{ getSzervezetNevById(ujTema.szervezetID)
              }}
            </p>
          </div>
          <button type="submit">Téma felvétele</button>
        </form>
        <p v-if="uzenet">{{ uzenet }}</p>

        <!-- Hallgató hozzáadása modal -->
        <div v-if="showHallgatoModal" class="modal">
          <h3>Új hallgató hozzáadása</h3>
          <form @submit.prevent="addHallgato">
            <input
              placeholder="Hallgató neve"
              id="hallgatoNev"
              v-model="ujHallgato.nev"
              required
            />

            <input
              placeholder="Neptun kódja"
              id="hallgatoNeptun"
              v-model="ujHallgato.neptun"
              required
            />

            <input
              placeholder="Email címe"
              id="hallgatoEmail"
              v-model="ujHallgato.email"
              type="email"
              required
            />

            <button type="submit">Hozzáadás</button>
            <button type="button" @click="showHallgatoModal = false">
              Mégse
            </button>
          </form>
          <p v-if="hallgatoUzenet">{{ hallgatoUzenet }}</p>
        </div>

        <!-- Bírálóként hozzárendelt témák -->
        <h2>Bírálóként hozzárendelt témák</h2>
        <ul>
          <li v-for="tema in biraloTemak" :key="tema.temaID">
            <div><b>Téma: </b>{{ tema.temaCim }}</div>
            <div>
            <button @click="megtekintTemakiirolap(tema.temaID)">
              Témakiíró lap megtekintése
            </button>
          </div>

            <!-- Elfogadás és Elutasítás gombok -->
            <div v-if="tema.biralva === 1">
              <button @click="elfogadFelkeres(tema.temaID)">Elfogadás</button>
              <button @click="elutasitFelkeres(tema.temaID)">Elutasítás</button>
            </div>

            <!-- Bírálat feltöltése gomb -->
            <!--<div v-else-if="tema.biralva === 2">
              <button @click="openDokumentModal(tema.temaID)">Kapcsolódó dokumentumok</button>
              <button @click="feltoltBiralat(tema.temaID)">
                Bírálat feltöltése
              </button>
            </div>-->
            <div v-else-if="tema.biralva === 2">
              <div v-if="!tema.titoktartasMasTolt || (tema.titoktartasMasTolt && tema.titoktartasEnTolt)">
                <!-- Ha nincs más által feltöltve vagy ha van, de én is feltöltöttem -->
                <button @click="openDokumentModal(tema.temaID)">Kapcsolódó dokumentumok</button>
                <button @click="openBiraloModal(tema.temaID)">Bírálat feltöltése</button>
              </div>
            
              <div v-else>
                <!-- Ha van más által feltöltve, de én még nem töltöttem fel -->
                <p><strong>Kapcsolódó dokumentumok megtekintéséhez titoktartási nyilatkozat szükséges.</strong></p>
            <button v-if="tema.titoktartasMasTolt" @click="downloadTitoktartas(tema.temaID)">
                  Titoktartási nyilatkozat letöltése
                </button>
                <button @click="feltoltDokumentum(tema.temaID, 3)">Kitöltött titoktartási nyilatkozat feltöltése</button>
            
                
              </div>
            </div>

            <!-- Bírálat feltöltve -->
            <div v-else-if="tema.biralva === 3">
              <p>Bírálat feltöltve</p>
              <button @click="openDokumentModal(tema.temaID)">Kapcsolódó dokumentumok</button>
            </div>
          </li>
        </ul>
        <!-- Kapcsolódó dokumentumok modal -->
        <div v-if="showDokumentModal" class="modal">
          <h3>Kapcsolódó dokumentumok</h3>
          <div><b>Téma:</b> {{ kivalasztottTemaCimDok}}</div>
          <ul>
            <li v-for="dokumentum in temaDokumnetumok":key="dokumentum.dokID">
              
              <strong>Fájl:</strong> {{ dokumentum.eredeti_nev }}<br />
              <strong>Típus:</strong> {{ getDokumentumTipus(dokumentum.tipus) }}
              <button @click="downloadFile(dokumentum.eleres)">Letöltés</button>
            </li>
          </ul>
          <button @click="showDokumentModal = false">Bezárás</button>
        </div>

        <!-- Bírálat feltöltése modal -->
        <div v-if="showBiralatModal" class="modal">
          <h3>Bírálat feltöltése</h3>
          <p>Téma: {{ kivalasztottTemaCim }}</p>
          <input type="file" @change="handleBiralatFileUpload" />
          <button @click="uploadBiralat">Feltöltés</button>
          <button @click="showBiralatModal = false">Mégse</button>
          <p>{{ biralatUploadMessage }}</p>
        </div>
      </div>
    </div>
    <script>
      axios.defaults.withCredentials = true;
      Vue.component("tree-item", {
        props: ["item", "selectedId"],
        data() {
          return {
            isOpen: false, // A kibontás állapota
          };
        },
        computed: {
          hasChildren() {
            return this.item.children && this.item.children.length > 0;
          },
          isSelected() {
            return this.item.szervezetID === this.selectedId;
          },
        },
        methods: {
          toggle() {
            this.isOpen = !this.isOpen;
          },
          select() {
            this.$emit("select", this.item.szervezetID);
          },
        },
        template: `
        <li :class="{ selected: isSelected }">
          <div @click="toggle" style="cursor: pointer;">
            <span v-if="hasChildren">{{ isOpen ? '-' : '+' }}</span>
            <span @click.stop="select">{{ item.szervezetNEV }}</span>
          </div>
          <ul v-if="isOpen && hasChildren">
            <tree-item
              v-for="child in item.children"
              :key="child.szervezetID"
              :item="child"
              :selected-id="selectedId"
              @select="$emit('select', $event)"
            ></tree-item>
          </ul>
        </li>
      `,
      });

      new Vue({
        el: "#app-auth",
        data() {
          return {
            auth: false,
            user: null,
            hallgatok: [],
            files: [],
            nev: "",
            neptun: "",
            email: "",
            uzenet: "",
            keresettID: "",
            hallgato: null,
            hibaUzenet: "",
            selectedFile: null,
            selectedType: "1",
            selectedTemaID: null,
            temak: [], // Témák listája
            uploadMessage: "",
            ujTema: {
              temaCim: "",
              kapcsolodoTemaID: "", // Kapcsolódó téma ID
              hallgatoID: "",
              szervezetID: "",
              extraKonzulensID: "", // További konzulens ID
            },
            temaUzenet: "",
            szervezetek: [], // Szervezetek hierarchikus listája
            isSzervezetValasztasOpen: false, // Szervezetválasztó nyitott állapota
            konzulensTemak: [],
            biraloTemak: [], // Bírálóhoz tartozó témák
            resztvevok: [], // Résztvevők listája
            biralok: [],
            temaDokumnetumok: [], // Témával kapcsolatos dokumentumok
            showModal: false,
            kivalasztottTemaID: null,
            kivalasztottBiralo: null,
            kivalasztottTemaCim: null, // Téma címének tárolása
            kivalasztottTemaIDdok: null,
            kivalasztottTemaCimDok: null,
            showBiralatModal: false,
            biralatUploadMessage: "",
            showHallgatoModal: false,
            showUzenetModal: false,
            showDokumentModal: false,
            ujHallgato: {
              nev: "",
              neptun: "",
              email: "",
            },
            hallgatoUzenet: "",
            tipus: "",
            tartalom: "",
            TemakSearchQuery: "",
            uzenetek: [],
          };
        },
        computed: {
          filteredTemak() {
            const query = this.TemakSearchQuery.toLowerCase();
            return this.konzulensTemak.filter((tema) =>
              tema.temaCim.toLowerCase().includes(query)
            );
          },
        },
        methods: {
          async checkLoginStatus() {
            try {
              const res = await axios.get("http://localhost:3000/api/user");
              this.user = res.data;
              this.auth = true;
              this.refreshData(); // Frissítjük az adatokat bejelentkezés után
            } catch (err) {
              this.auth = false;
              this.user = null;
              this.refreshData(); // Töröljük az adatokat kijelentkezés után
            }
          },
          login() {
            const width = 450;
            const height = 500;
            const left = (window.screen.width - width) / 2;
            const top = (window.screen.height - height) / 2 - 100;
            const loginWindow = window.open(
              "login.html",
              "Bejelentkezés",
              `width=${width},height=${height},left=${left},top=${top},resizable=no,scrollbars=no`
            );
           

            // Figyeljük, hogy a bejelentkezés sikeres-e
            const interval = setInterval(() => {
              if (loginWindow.closed) {
                clearInterval(interval);
                this.checkLoginStatus(); // Ellenőrizzük a bejelentkezési állapotot
                this.refreshData(); // Frissítjük az adatokat
              }
            }, 500);
          }, 
          OpenAdnimPage() {
              window.location.href = "admin.html";
          },

          async logout() {
            try {
              await axios.post("http://localhost:3000/api/logout", {});
              this.auth = false;
              this.user = null;
              this.refreshData(); // Frissítjük az adatokat kijelentkezés után
            } catch (err) {
              console.error("Kijelentkezési hiba:", err);
            }
          },
          async kuldes() {
            try {
              const res = await fetch("http://localhost:3000/api/hallgato", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  hallgatoNEV: this.nev,
                  hallgatoNK: this.neptun,
                  hallgatoEMAIL: this.email,
                }),
              });
              if (!res.ok) throw new Error(`Hiba: ${res.status}`);
              const data = await res.json();
              this.uzenet = data.message;
              this.nev = this.neptun = this.email = "";
              this.loadHallgatok(); // újratöltjük
            } catch (err) {
              console.error(err);
              this.uzenet = "Hiba történt a hozzáadáskor.";
            }
          },
          async loadHallgatok() {
            try {
              const res = await fetch("http://localhost:3000/api/hallgatok");
              this.hallgatok = await res.json();
            } catch (err) {
              console.error("Hallgatók betöltése hiba:", err);
            }
          },
          async keresHallgato() {
            try {
              const res = await fetch(
                `http://localhost:3000/api/hallgatok/${this.keresettID}`
              );
              if (!res.ok) throw new Error(`Hiba: ${res.status}`);
              const data = await res.json();
              if (data.length === 0) {
                this.hibaUzenet = "Nem található hallgató ezzel az ID-val.";
                this.hallgato = null;
              } else {
                this.hallgato = data[0];
                this.hibaUzenet = "";
              }
            } catch (err) {
              console.error(err);
              this.hibaUzenet = "Hiba történt a lekérdezés során.";
              this.hallgato = null;
            }
          },
          handleFileUpload(event) {
            this.selectedFile = event.target.files[0];
          },
          async fetchTemak() {
            try {
              const res = await fetch("http://localhost:3000/api/temak");
              this.temak = await res.json();
              console.log("Betöltött témák:", this.temak); // Ellenőrzés
            } catch (err) {
              console.error("Témák betöltése hiba:", err);
            }
          },
          async uploadFile() {
            if (!this.selectedFile || !this.selectedTemaID) {
              this.uploadMessage = "Kérlek válassz ki fájlt és témát!";
              return;
            }
            const formData = new FormData();
            formData.append("file", this.selectedFile);
            formData.append("tipus", this.selectedType);
            formData.append("temaID", this.selectedTemaID);
            //formData.append("feltolto", this.user.rvID);
            try {
              const res = await fetch("http://localhost:3000/api/feltoltes", {
                method: "POST",
                body: formData,
                credentials: "include",
              });
              if (!res.ok) throw new Error(`Feltöltési hiba: ${res.status}`);
              const data = await res.json();
              this.uploadMessage = `Sikeresen feltöltve: ${data.fileName}`;
              this.selectedFile = null;
              this.loadFiles(); // újratöltjük a listát
            } catch (err) {
              console.error("Fájl feltöltési hiba:", err);
              this.uploadMessage = "Hiba történt a feltöltéskor.";
            }
          },
          //fájlok törlése
          async torolDokumentum(id) {
            try {
              await fetch(`http://localhost:3000/api/dokumentum/${id}`, {
                method: "DELETE",
                credentials: "include", // fontos, hogy elküldje a session cookiet
              });
              this.loadFiles(); // újratölti a listát
            } catch (err) {
              console.error("Törlési hiba:", err);
            }
          },
          confirmDelete(id) {
            if (confirm("Biztosan törölni szeretnéd a fájlt?")) {
              this.torolDokumentum(id);
            }
          },
          async loadFiles() {
            try {
              const res = await fetch(
                "http://localhost:3000/api/feltoltott-fajlok",
                { method: "GET", credentials: "include" }
              );
              this.files = await res.json();
            } catch (err) {
              console.error("Fájlok betöltése hiba:", err);
            }
          },
          async downloadFile(filename) {
            const url = `http://localhost:3000/api/letoltes/${filename}`;
            window.open(url, "_blank");
          },
          handleLoginSuccess() {
            this.checkLoginStatus();
          },
          messageListener(event) {
            if (event.data === "loginSuccess") {
              this.handleLoginSuccess();
              this.refreshData(); // Frissítjük az adatokat bejelentkezés után
            }
          },
          async submitTema() {
            try {
              const res = await fetch("http://localhost:3000/api/tema", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                credentials: "include",
                body: JSON.stringify(this.ujTema),
              });
              if (!res.ok) throw new Error("Téma mentése nem sikerült");
              const data = await res.json();
              this.temaUzenet = `Sikeresen mentve, ID: ${data.temaID}`;
              this.ujTema = {
                temaCim: "",
                kapcsolodoTemaID: "", // Kapcsolódó téma ID
                hallgatoID: "",
                szervezetID: "",
                extraKonzulensID: "", // További konzulens ID
              };
              this.isSzervezetValasztasOpen = false; // Bezárja a szervezetválasztót
              this.fetchTemak(); // Témák frissítése
              this.fetchKonzulensTemak(); // Konzulens témák frissítése
              alert("Téma sikeresen felvéve.");
            } catch (err) {
              console.error("Téma mentési hiba:", err);
              this.temaUzenet = "Hiba történt a mentés során.";
            }
          },
          async fetchSzervezetek() {
            try {
              const response = await axios.get(
                "http://localhost:3000/api/szervezetek"
              );
              const flatData = response.data;

              // Hierarchikus struktúra létrehozása
              const map = {};
              flatData.forEach((item) => {
                map[item.szervezetID] = { ...item, children: [] };
              });

              const tree = [];
              flatData.forEach((item) => {
                if (item.felettesID) {
                  map[item.felettesID].children.push(map[item.szervezetID]);
                } else {
                  tree.push(map[item.szervezetID]);
                }
              });

              this.szervezetek = tree;
            } catch (error) {
              console.error("Hiba a szervezetek lekérésekor", error);
            }
          },

          async loadResztvevok() {
            try {
              const res = await fetch("http://localhost:3000/api/resztvevok");
              this.resztvevok = await res.json();
            } catch (err) {
              console.error("Résztvevők betöltése hiba:", err);
            }
          },
          toggleSzervezetValasztas() {
            this.isSzervezetValasztasOpen = !this.isSzervezetValasztasOpen;
          },
          getSzervezetNevById(id) {
            const findSzervezet = (szervezetek, id) => {
              for (const szervezet of szervezetek) {
                if (szervezet.szervezetID === id) {
                  return szervezet.szervezetNEV;
                }
                if (szervezet.children && szervezet.children.length > 0) {
                  const nev = findSzervezet(szervezet.children, id);
                  if (nev) return nev;
                }
              }
              return null;
            };
            return findSzervezet(this.szervezetek, id) || "Nincs kiválasztva";
          },
          
          openModal(temaID) {
            console.log("Kiválasztott téma ID:", temaID); // Ellenőrzés
            const tema = this.konzulensTemak.find((t) => t.temaID === temaID);
            if (tema) {
              this.kivalasztottTemaCim = tema.temaCim; // Téma címének beállítása
            }
            this.kivalasztottTemaID = temaID;
            this.showModal = true; // Modális ablak megnyitása
            console.log("showModal értéke:", this.showModal); // Ellenőrzés
            this.fetchBiralok(temaID); // Bírálók lekérése
          },
          fetchBiralok(temaID) {
            fetch(`http://localhost:3000/api/osszes-biralo/${temaID}`, {
              credentials: "include", // Küldi a session cookie-t
            })
              .then((res) => res.json())
              .then((data) => {
                this.biralok = data;
              })
              .catch((err) => {
                console.error("Hiba a bírálók lekérésekor:", err);
              });
          },
          async fetchBiraloTemak() {
            try {
              const res = await fetch(
                "http://localhost:3000/api/biralo-temak",
                {
                  credentials: "include",
                }
              );
              if (!res.ok) throw new Error("Hiba a bíráló témák lekérésekor.");
              const temak = await res.json();

              // Duplikációk eltávolítása
              const uniqueTemak = temak.filter(
                (tema, index, self) =>
                  index === self.findIndex((t) => t.temaID === tema.temaID)
              );

              this.biraloTemak = uniqueTemak;
              console.log("Bíráló témák:", this.biraloTemak);
            } catch (err) {
              console.error("Hiba a bíráló témák lekérésekor:", err);
            }
          },
          async fetchKonzulensTemak() {
            try {
              const res = await fetch(
                "http://localhost:3000/api/konzulens-temak",
                {
                  credentials: "include", // Küldi a session cookie-t
                }
              );
              if (!res.ok)
                throw new Error("Hiba a konzulens témák lekérésekor.");
              this.konzulensTemak = await res.json();
              console.log("Konzulens témák:", this.konzulensTemak); // Ellenőrzés
            } catch (err) {
              console.error("Hiba a konzulens témák lekérésekor:", err);
            }
          },
          async megtekintTemakiirolap(temaID) {
            try {
              const res = await fetch(
                `http://localhost:3000/api/temakiirolap/${temaID}`
              );
              if (!res.ok) {
                throw new Error("Hiba a dokumentumok lekérésekor.");
              }

              const dokumentumok = await res.json();
              if (dokumentumok.length > 0) {
                const eleres = dokumentumok[0].eleres; // Az első dokumentum elérési útvonala
                window.open(
                  `http://localhost:3000/uploads/${eleres}`,
                  "_blank"
                ); // Dokumentum megnyitása új lapon
              } else {
                alert("Ehhez a témához nincs témakiíró dokumentum.");
              }
            } catch (err) {
              console.error("Hiba a dokumentum megtekintésekor:", err);
              alert("Hiba történt a dokumentum megtekintésekor.");
            }
          },
         
          async downloadTitoktartas(temaID) {
            try {
              const res = await fetch(
                `http://localhost:3000/api/titoktartas/${temaID}`
              );
              if (!res.ok) {
                throw new Error("Hiba a dokumentumok lekérésekor.");
              }

              const dokumentumok = await res.json();
              if (dokumentumok.length > 0) {
                const eleres = dokumentumok[0].eleres; // Az első dokumentum elérési útvonala
                window.open(
                  `http://localhost:3000/uploads/${eleres}`,
                  "_blank"
                ); // Dokumentum megnyitása új lapon
              } else {
                alert("Ehhez a témához nincs témakiíró dokumentum.");
              }
            } catch (err) {
              console.error("Hiba a dokumentum megtekintésekor:", err);
              alert("Hiba történt a dokumentum megtekintésekor.");
            }
          },
          async fetchTemaDokumentumok(temaID) {
            try {
              const res = await fetch(
                `http://localhost:3000/api/tema-dokumentumok/${temaID}`,
                {
                  credentials: "include", // Küldi a session cookie-t
                }
              );
              if (!res.ok) throw new Error("Hiba a dokumentumok lekérésekor.");
              this.temaDokumnetumok = await res.json(); // Dokumentumok mentése
            } catch (err) {
              console.error("Hiba a dokumentumok lekérésekor:", err);
              alert("Hiba történt a dokumentumok lekérésekor.");
            }
          },
          async getTemaCimByID(kivalasztottTemaIDdok) {
            try {
              const res = await fetch(
                `http://localhost:3000/api/temacim/${kivalasztottTemaIDdok}`,
                {
                  credentials: "include", // Küldi a session cookie-t
                }
              );

              if (!res.ok) {
                throw new Error("Hiba a téma címének lekérésekor.");
              }

              const tema = await res.json();
              return tema.temaCim; // Visszaadjuk a téma címét
            } catch (err) {
              console.error("Hiba a téma címének lekérésekor:", err);
              alert("Hiba történt a téma címének lekérésekor.");
              return null; // Hiba esetén `null`-t adunk vissza
            }
          },
          async elfogadFelkeres(temaID) {
            try {
              const res = await fetch(
                "http://localhost:3000/api/elfogad-felkeres",
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  credentials: "include",
                  body: JSON.stringify({ temaID }),
                }
              );

              if (!res.ok) {
                throw new Error("Hiba a felkérés elfogadásakor.");
              }

              const data = await res.json();
              alert(data.message || "Felkérés sikeresen elfogadva!");

              // Frissítsd a témák állapotát
              const tema = this.biraloTemak.find((t) => t.temaID === temaID);
              if (tema) tema.biralva = 2;
              this.fetchBiraloTemak(); // Bíráló témák újratöltése
            } catch (err) {
              console.error("Hiba a felkérés elfogadásakor:", err);
              alert("Hiba történt a felkérés elfogadásakor.");
            }
          },

          async elutasitFelkeres(temaID) {
            try {
              const res = await fetch(
                "http://localhost:3000/api/elutasit-felkeres",
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  credentials: "include",
                  body: JSON.stringify({ temaID }),
                }
              );

              if (!res.ok) {
                throw new Error("Hiba a felkérés elutasításakor.");
              }

              const data = await res.json();
              alert(data.message || "Felkérés sikeresen elutasítva!");

              // Frissítsd a témák állapotát
              const tema = this.biraloTemak.find((t) => t.temaID === temaID);
              if (tema) tema.biralva = 0;
              this.fetchBiraloTemak(); // Bíráló témák újratöltése
            } catch (err) {
              console.error("Hiba a felkérés elutasításakor:", err);
              alert("Hiba történt a felkérés elutasításakor.");
            }
          },
          async feltoltBiralat(temaID) {
            const tema = this.biraloTemak.find((t) => t.temaID === temaID);
            if (tema) {
              this.kivalasztottTemaCim = tema.temaCim; // Téma címének beállítása
            }
            this.kivalasztottTemaID = temaID; // Aktuális téma ID
            this.showBiralatModal = true; // Modális ablak megnyitása
          },
          handleBiralatFileUpload(event) {
            this.selectedFile = event.target.files[0];
          },
          async uploadBiralat() {
            if (!this.selectedFile || !this.kivalasztottTemaID) {
              this.biralatUploadMessage =
                "Kérlek válassz ki fájlt és témát a bírálathoz!";
              return;
            }
            const formData = new FormData();
            formData.append("file", this.selectedFile);
            formData.append("temaID", this.kivalasztottTemaID);
            try {
              const res = await fetch(
                "http://localhost:3000/api/feltolt-biralat",
                {
                  method: "POST",
                  body: formData,
                  credentials: "include",
                }
              );
              if (!res.ok) throw new Error(`Feltöltési hiba: ${res.status}`);
              const data = await res.json();
              this.biralatUploadMessage = `Sikeresen feltöltve: ${data.fileName}`;
              this.selectedFile = null;
              this.showBiralatModal = false;
              this.fetchBiraloTemak(); // Bíráló témák újratöltése
            } catch (err) {
              console.error("Bírálat feltöltési hiba:", err);
              this.biralatUploadMessage =
                "Hiba történt a bírálat feltöltésekor.";
            }
          },
          async downloadBiralat(temaID) {
            try {
              const res = await fetch(
                `http://localhost:3000/api/tema-biralat/${temaID}`,
                {
                  credentials: "include",
                }
              );

              if (!res.ok) {
                throw new Error("Hiba a bírálat letöltésekor.");
              }

              const data = await res.json();
              if (data.eleres) {
                const url = `http://localhost:3000/uploads/${data.eleres}`;
                window.open(url, "_blank"); // Megnyitja a fájlt új lapon
              } else {
                alert("Ehhez a témához nincs feltöltött bírálat.");
              }
            } catch (err) {
              console.error("Hiba a bírálat letöltésekor:", err);
              alert("Hiba történt a bírálat letöltésekor.");
            }
          },
          async feltoltDokumentum(temaID, tipus) {
            const fileInput = document.createElement("input");
            fileInput.type = "file";
            fileInput.accept = ".pdf,.doc,.docx"; // Csak bizonyos fájltípusokat engedélyezünk
            fileInput.onchange = async (event) => {
              const file = event.target.files[0];
              if (!file) return;

              const formData = new FormData();
              formData.append("file", file);
              formData.append("temaID", temaID);
              formData.append("tipus", tipus);

              try {
                const res = await fetch("http://localhost:3000/api/feltoltes", {
                  method: "POST",
                  body: formData,
                  credentials: "include",
                });
                if (!res.ok) throw new Error("Hiba a fájl feltöltésekor.");
                alert("Fájl sikeresen feltöltve!");
                this.fetchKonzulensTemak(); // Témák újratöltése
                this.fetchBiraloTemak(); // Bíráló témák újratöltése
              } catch (err) {
                console.error("Hiba a fájl feltöltésekor:", err);
                alert("Hiba történt a fájl feltöltésekor.");
              }
            };
            fileInput.click();
          },
          felkeresBiralo() {
            if (!this.kivalasztottBiralo) {
              alert("Kérlek válassz ki egy bírálót!");
              return;
            }

            fetch("http://localhost:3000/felkeres-biralot", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                temaID: this.kivalasztottTemaID,
                biraloID: this.kivalasztottBiralo,
              }),
            })
              .then((res) => {
                if (!res.ok) {
                  if (res.status === 400) {
                    // Ha a státuszkód 400, akkor a bíráló már fel van kérve
                    return res.json().then((data) => {
                      throw new Error(
                        data.error || "Ez a bíráló már egyszer fel volt kérve."
                      );
                    });
                  }
                  throw new Error("Hiba történt a bíráló felkérésekor.");
                }
                return res.json();
                this.fetchKonzulensTemak();
              })
              .then((data) => {
                alert(data.message || "Bíráló sikeresen felkérve!");
                this.showModal = false; // Modális ablak bezárása
                this.kivalasztottTemaID = null;
                this.kivalasztottBiralo = null;
                this.fetchKonzulensTemak(); // Témák újratöltése
              })
              .catch((err) => {
                console.error("Hiba a bíráló felkérésekor:", err);
                alert(err.message || "Hiba történt a bíráló felkérésekor.");
              });
          },
          async addHallgato() {
            try {
              const res = await fetch("http://localhost:3000/api/hallgato", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  hallgatoNEV: this.ujHallgato.nev,
                  hallgatoNK: this.ujHallgato.neptun,
                  hallgatoEMAIL: this.ujHallgato.email,
                }),
              });

              if (!res.ok) throw new Error(`Hiba: ${res.status}`);
              const data = await res.json();
              this.hallgatoUzenet = data.message;
              this.ujHallgato = { nev: "", neptun: "", email: "" }; // Mezők ürítése
              this.showHallgatoModal = false; // Modális ablak bezárása
              this.loadHallgatok(); // Hallgatók újratöltése
            } catch (err) {
              console.error("Hiba a hallgató hozzáadásakor:", err);
              this.hallgatoUzenet = "Hiba történt a hallgató hozzáadásakor.";
            }
          },
          refreshData() {
            if (this.auth) {
              this.fetchTemak(); // Témák betöltése
              this.fetchKonzulensTemak(); // Konzulens témák betöltése
              this.fetchBiraloTemak(); // Bíráló témák betöltése
              this.loadHallgatok(); // Hallgatók betöltése
              this.loadResztvevok(); // Résztvevők betöltése
              this.fetchSzervezetek(); // Szervezetek betöltése
              this.fetchSajatUzenetek(); // Üzenetek betöltése

            } else {
              // Ha nincs bejelentkezve, töröljük az adatokat
              this.temak = [];
              this.konzulensTemak = [];
              this.biraloTemak = [];
              this.hallgatok = [];
              this.resztvevok = [];
              this.szervezetek = [];
            }
          },
          getDokumentumTipus(tipus) {
            switch (
              Number(tipus) // A `tipus` értékét számmá alakítjuk
            ) {
              case 1:
                return "Témakiíró lap";
              case 2:
                return "Szakdolgozat";
              case 3:
                return "Titoktartási nyilatkozat";
              case 4:
                return "Bírálat";
              case 5:
                return "Egyéb";
              default:
                return "Ismeretlen típus";
            }
          },

          async kuldesUzenet() {
      try {
        const res = await axios.post("http://localhost:3000/api/uzenet", {
          tipus: this.tipus,
          tartalom: this.tartalom
        }, { withCredentials: true });

        alert(res.data.message);
        this.tipus = "";
        this.tartalom = "";
        this.showUzenetModal = false; // Modális ablak bezárása
        this.refreshData(); // Adatok frissítése
         // Modális ablak bezárása

      } catch (err) {
        console.error("Hiba az üzenet küldésekor:", err);
        alert("Nem sikerült az üzenet küldése.");
      }
    },
    async openDokumentModal(temaID) {
  this.kivalasztottTemaIDdok = temaID;
  this.showDokumentModal = true;
  this.fetchTemaDokumentumok(temaID); // feltöltés

  // Itt lekéred a címét is és elmented
  const cim = await this.getTemaCimByID(temaID);
  this.kivalasztottTemaCimDok = cim;
},
async openBiraloModal(temaID) {
  console.log("openBiraloModal meghívva, temaID:", temaID);
  this.kivalasztottTemaID = temaID;
  this.showBiralatModal = true;
  console.log("showBiralatModal állapota:", this.showBiralatModal);

  try {
    const cim = await this.getTemaCimByID(temaID);
    this.kivalasztottTemaCim = cim;
    console.log("Lekért téma cím:", cim);
  } catch (err) {
    console.error("Hiba a téma címének lekérésekor:", err);
  }
},
async fetchSajatUzenetek() {
  try {
    const res = await fetch("http://localhost:3000/api/sajat-uzenetek", {
      credentials: "include", // Küldi a session cookie-t
    });
    if (!res.ok) throw new Error("Hiba az üzenetek lekérésekor.");
    this.uzenetek = await res.json();
  } catch (err) {
    console.error("Hiba az üzenetek lekérésekor:", err);
  }
}

        },
        created() {
          this.checkLoginStatus();
          this.fetchTemak();
          this.loadHallgatok();
          this.fetchSzervezetek();
          this.loadResztvevok();
          this.fetchBiraloTemak(); // Bíráló témák betöltése
          this.fetchKonzulensTemak(); // Konzulens témák betöltése
          this.fetchSajatUzenetek(); // Üzenetek betöltése
          window.addEventListener("message", this.messageListener);
        },

        beforeDestroy() {
          window.removeEventListener("message", this.messageListener);
        },
      });
    </script>
  </body>
</html>

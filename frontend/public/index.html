<!DOCTYPE html>
<html lang="hu">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hallgatók</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="style/index.css" />
  </head>
  <body>
    <div id="app-auth">
      <div v-if="!auth">
        <p>Üdvözlünk az oldalon, kérem jelentkezzen be</p>
        <button @click="login">Bejelentkezés</button>
      </div>
      <div v-else>
        <button @click="logout">Kijelentkezés</button>
        <p>Üdv, {{ user.rvFelhasznalonev }} ({{ user.rvEmail }})!</p>
        <h1>Hallgatók adatainak megjelenítése</h1>
        <button id="loadDataButton">Adatok betöltése</button>
        <ul id="hallgatoList"></ul>

        <div id="app-hozzaadas">
          <h2>Hallgató hozzáadása</h2>
          <input v-model="nev" placeholder="Név" />
          <input v-model="neptun" placeholder="Neptun kód" />
          <input v-model="email" placeholder="Email" />
          <button @click="kuldes">Küldés</button>
          <p>{{ uzenet }}</p>
        </div>

        <div id="app-IDlekerdezes">
          <h2>Hallgató lekérdezése ID alapján</h2>
          <input v-model="keresettID" type="number" placeholder="Hallgató ID" />
          <button @click="keresHallgato">Keresés</button>
          <div v-if="hallgato">
            <h3>Hallgató adatai:</h3>
            <p>Név: {{ hallgato.hallgatoNEV }}</p>
            <p>Neptun kód: {{ hallgato.hallgatoNK }}</p>
            <p>Email: {{ hallgato.hallgatoEMAIL }}</p>
          </div>
          <p v-if="hibaUzenet" style="color: red">{{ hibaUzenet }}</p>
        </div>

        <div id="app-feltoltes">
          <h2>Fájl feltöltése</h2>
          <input type="file" @change="handleFileUpload" />
          <select v-model="selectedType">
            <option value="1">Szakdolgozat</option>
            <option value="2">Bírálat</option>
            <option value="3">Egyéb</option>
          </select>
          <select v-model="selectedTemaID">
            <option
              v-for="tema in temak"
              :key="tema.temaID"
              :value="tema.temaID"
            >
              {{ tema.temaCim }}
            </option>
          </select>
          <button @click="uploadFile">Feltöltés</button>
          <p>{{ uploadMessage }}</p>
        </div>

        <div id="app-file-list">
          <h2>Feltöltött fájlok</h2>
          <button id="loadFilesButton">Fájlok betöltése</button>
          <ul id="fileList"></ul>
          <!-- Itt fog megjelenni a fájlok listája -->
        </div>
      </div>
    </div>

    <script>
      // Engedélyezzük a cookie-k továbbítását minden Axios kérésnél
      axios.defaults.withCredentials = true;
      new Vue({
        el: "#app-IDlekerdezes",
        data() {
          return {
            keresettID: "",
            hallgato: null,
            hibaUzenet: "",
          };
        },
        methods: {
          async keresHallgato() {
            try {
              const res = await fetch(
                `http://localhost:3000/api/hallgatok/${this.keresettID}`
              );
              if (!res.ok) {
                throw new Error(`Hiba történt: ${res.status}`);
              }
              const data = await res.json();
              if (data.length === 0) {
                this.hibaUzenet = "Nem található hallgató ezzel az ID-val.";
                this.hallgato = null;
              } else {
                this.hallgato = data[0];
                this.hibaUzenet = "";
              }
            } catch (err) {
              console.error(err);
              this.hibaUzenet = "Hiba történt a lekérdezés során.";
              this.hallgato = null;
            }
          },
        },
      });
    </script>

    <script>
      new Vue({
        el: "#app-hozzaadas",

        data() {
          return {
            nev: "",
            neptun: "",
            email: "",
            uzenet: "",
          };
        },
        methods: {
          async kuldes() {
            try {
              const res = await fetch("http://localhost:3000/api/hallgato", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  hallgatoNEV: this.nev,
                  hallgatoNK: this.neptun,
                  hallgatoEMAIL: this.email,
                }),
              });

              if (!res.ok) {
                throw new Error(`Helytelen adat (${res.status})`);
              }

              const data = await res.json();
              this.uzenet = data.message;
              this.nev = this.neptun = this.email = "";
            } catch (err) {
              console.error("Hiba történt:", err);
              this.uzenet = "Hiba történt: " + err.message;
            }
          },
        },
      });

      document
        .getElementById("loadDataButton")
        .addEventListener("click", async () => {
          try {
            // API hívás a backendhez a hallgatók lekérdezésére
            const response = await fetch("http://localhost:3000/api/hallgatok");
            const data = await response.json();

            // A listát ürítjük a frissítés előtt
            const listElement = document.getElementById("hallgatoList");
            listElement.innerHTML = "";

            // Adatok hozzáadása a listához
            data.forEach((hallgato) => {
              const listItem = document.createElement("li");
              listItem.textContent = `${hallgato.hallgatoNEV} - ${hallgato.hallgatoNK} - ${hallgato.hallgatoEMAIL}`;
              listElement.appendChild(listItem);
            });
          } catch (error) {
            alert("Hiba történt az adatok betöltésekor: " + error.message);
          }
        });
    </script>

    <script>
      new Vue({
        el: "#app-auth",
        data() {
          return {
            auth: false, // Alapértelmezett állapot: nincs bejelentkezve
            user: null, // Bejelentkezett felhasználó adatai
          };
        },
        methods: {
          async checkLoginStatus() {
            try {
              const res = await axios.get("http://localhost:3000/api/user", {
                withCredentials: true,
              });
              this.user = res.data;
              this.auth = true; // Bejelentkezett állapot
            } catch (err) {
              this.auth = false; // Nincs bejelentkezve
            }
          },
          async login() {
            const width = 450;
            const height = 500;
            const left = (window.screen.width - width) / 2;
            const top = (window.screen.height - height) / 2 - 100;

            const loginWindow = window.open(
              "login.html",
              "Bejelentkezés",
              `width=${width},height=${height},left=${left},top=${top},resizable=no,scrollbars=no`
            );

            // Üzenet fogadása a bejelentkezési ablakból
          },
          async logout() {
            try {
              await axios.post(
                "http://localhost:3000/api/logout",
                {},
                { withCredentials: true }
              );
              this.auth = false;
              this.user = null;
            } catch (err) {
              console.error("Hiba történt a kijelentkezés során:", err);
            }
          },

          async handleLoginSuccess() {
            await this.checkLoginStatus();
          },
          messageListener(event) {
            if (event.data === "loginSuccess") {
              this.handleLoginSuccess();
            }
          },
        },
        created() {
          this.checkLoginStatus(); // Itt nem kell async!
          window.addEventListener("message", this.messageListener);
        },
        beforeDestroy() {
          window.removeEventListener("message", this.messageListener);
        },
      });
    </script>

    <script>
      new Vue({
        el: "#app-feltoltes",
        data() {
          return {
            selectedFile: null,
            selectedType: "1", // Alapértelmezett típus
            selectedTemaID: null, // Kiválasztott téma ID
            temak: [], // Témák listája
            uploadMessage: "",
          };
        },
        methods: {
          handleFileUpload(event) {
            this.selectedFile = event.target.files[0];
          },
          async fetchTemak() {
            try {
              const response = await fetch("http://localhost:3000/api/temak");
              this.temak = await response.json();
            } catch (err) {
              console.error("Hiba történt a témák betöltésekor:", err);
            }
          },
          async uploadFile() {
            if (!this.selectedFile || !this.selectedTemaID) {
              this.uploadMessage = "Kérlek válassz ki egy fájlt és egy témát!";
              return;
            }

            const formData = new FormData();
            formData.append("file", this.selectedFile);
            formData.append("tipus", this.selectedType);
            formData.append("temaID", this.selectedTemaID);

            try {
              const res = await fetch("http://localhost:3000/api/feltoltes", {
                method: "POST",
                body: formData,
              });

              if (!res.ok) {
                throw new Error(
                  `Hiba történt a fájl feltöltésekor (${res.status})`
                );
              }

              const data = await res.json();
              this.uploadMessage = `A fájl sikeresen feltöltve: ${data.fileName}`;
            } catch (err) {
              console.error("Hiba történt:", err);
              this.uploadMessage = "Hiba történt a fájl feltöltésekor.";
            }
          },
        },
        async created() {
          await this.fetchTemak();
        },
      });
    </script>

    <script>
      document
        .getElementById("loadFilesButton")
        .addEventListener("click", async () => {
          try {
            const response = await fetch(
              "http://localhost:3000/api/feltoltott-fajlok"
            );
            const files = await response.json();

            const listElement = document.getElementById("fileList");
            listElement.innerHTML = ""; // Először ürítjük a listát

            // Fájlok hozzáadása a listához
            files.forEach((file) => {
              const listItem = document.createElement("li");
              listItem.textContent = `${file.eredeti_nev} (${file.eleres})`; // Eredeti fájlnév és elérési út
              listElement.appendChild(listItem);
            });
          } catch (error) {
            alert("Hiba történt a fájlok betöltésekor: " + error.message);
          }
        });
    </script>
  </body>
</html>
